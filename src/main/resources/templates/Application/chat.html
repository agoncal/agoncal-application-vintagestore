{#include base.html }
  {#title}AI Chat Assistant{/title}

  <!-- Breadcrumbs -->
  <div class="row mb-3">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/" class="text-decoration-none">
            <i class="bi bi-house me-1"></i>Home
          </a></li>
          <li class="breadcrumb-item active" aria-current="page">
            <i class="bi bi-chat-dots me-1"></i>AI Chat
          </li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- Chat Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 bg-primary text-white">
        <div class="card-body text-center py-4">
          <h1 class="display-6 fw-bold mb-2">
            <i class="bi bi-robot me-3"></i>AI Chat Assistant
          </h1>
          <p class="lead mb-0">Ask me anything about our vintage books and CDs collection!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Interface -->
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="card border-0 shadow-lg" style="height: 600px;">
        <div class="card-header bg-light">
          <div class="d-flex align-items-center">
            <div class="me-3">
              <i class="bi bi-circle-fill text-success" style="font-size: 0.8rem;"></i>
            </div>
            <div>
              <h6 class="mb-0">Vintage Store Assistant</h6>
              <small class="text-muted">Online and ready to help</small>
            </div>
          </div>
        </div>

        <div class="card-body d-flex flex-column p-0">
          <!-- Chat Input Area -->
          <div class="border-top p-3">
            <div class="input-group">
              <input type="text" id="chat-input" class="form-control" placeholder="Type your message here..." disabled>
              <button class="btn btn-primary" id="send-button" type="button" disabled>
                <i class="bi bi-send"></i>
              </button>
            </div>
            <small class="text-muted mt-2 d-block">
              <i class="bi bi-info-circle me-1"></i>WebSocket connection required for live chat
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Features -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-lightbulb me-2"></i>How I Can Help</h5>
          <div class="row g-3">
            <div class="col-md-4">
              <div class="d-flex align-items-start">
                <i class="bi bi-book text-primary me-2 mt-1"></i>
                <div>
                  <h6>Book Information</h6>
                  <small class="text-muted">Ask about authors, publication dates, categories, and availability</small>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex align-items-start">
                <i class="bi bi-disc text-primary me-2 mt-1"></i>
                <div>
                  <h6>Music Collection</h6>
                  <small class="text-muted">Find albums by genre, artist, or get recommendations</small>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-flex align-items-start">
                <i class="bi bi-search text-primary me-2 mt-1"></i>
                <div>
                  <h6>Smart Search</h6>
                  <small class="text-muted">Get personalized recommendations based on your interests</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const chatMessages = document.getElementById('chat-messages');
      const chatInput = document.getElementById('chat-input');
      const sendButton = document.getElementById('send-button');

      // WebSocket connection for real-time chat
      let websocket;

      function connectWebSocket() {
        try {
          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          const wsUrl = protocol + '//' + window.location.host + '/chat';
          websocket = new WebSocket(wsUrl);

          websocket.onopen = function() {
            console.log('Connected to chat');
            chatInput.disabled = false;
            sendButton.disabled = false;
            chatInput.placeholder = 'Type your message here...';
          };

          websocket.onmessage = function(event) {
            addMessage('assistant', event.data);
          };

          websocket.onclose = function() {
            console.log('Disconnected from chat');
            chatInput.disabled = true;
            sendButton.disabled = true;
            chatInput.placeholder = 'Chat unavailable - WebSocket disconnected';
          };

          websocket.onerror = function(error) {
            console.error('WebSocket error:', error);
            addMessage('system', 'Connection error. Please refresh the page.');
          };
        } catch (error) {
          console.error('Failed to connect:', error);
          addMessage('system', 'Unable to connect to chat service.');
        }
      }

      function addMessage(sender, message) {
        const messageDiv = document.createElement('div');
        const isUser = sender === 'user';
        const isAssistant = sender === 'assistant';

        messageDiv.className = 'd-flex justify-content-' + (isUser ? 'end' : 'start') + ' mb-3';

        const messageCard = document.createElement('div');
        messageCard.className = 'card border-0 ' + (isUser ? 'bg-primary text-white' : 'bg-light');
        messageCard.style.maxWidth = '75%';

        const iconClass = isUser ? 'person' : (isAssistant ? 'robot' : 'exclamation-circle');
        const textClass = isUser ? 'text-white-50' : 'text-muted';
        const senderName = isUser ? 'You' : (isAssistant ? 'Assistant' : 'System');

        messageCard.innerHTML = '<div class="card-body p-3">' +
          '<div class="d-flex align-items-center mb-2">' +
          '<i class="bi bi-' + iconClass + ' me-2"></i>' +
          '<small class="' + textClass + '">' + senderName + '</small>' +
          '</div>' +
          '<p class="mb-0">' + message + '</p>' +
          '</div>';

        messageDiv.appendChild(messageCard);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function sendMessage() {
        const message = chatInput.value.trim();
        if (message && websocket && websocket.readyState === WebSocket.OPEN) {
          addMessage('user', message);
          websocket.send(message);
          chatInput.value = '';
        }
      }

      sendButton.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      // Connect to WebSocket
      connectWebSocket();
    });
  </script>

{/include}
