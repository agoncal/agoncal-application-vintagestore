@startuml
!theme plain
title Remembering the Conversation

actor User
box "Local" #LightGreen
participant "WebSocket\n/chat" as WS
participant "VintageStore\nChatBot" as ChatBot
participant "VintageStore\nAssistant" as Assistant
end box
box "Anthropic" #LightPink
entity "Claude Sonnet\n(Chat)" as Anthropic
end box
box "Mistral AI" #LightPink
entity "Mistral\nModeration" as Mistral
end box
box "Docker" #LightBlue
database "Redis\n(Chat Memory)" as Redis
database "PostgreSQL\n(VintageStore DB)" as PostgreSQL
end box

== Chat ==
User -[#blue]> WS: Send message
activate WS
WS -[#blue]> ChatBot: @OnTextMessage(message)
activate ChatBot

alt CLEAR_CONVERSATION
    ChatBot -> Redis: deleteMessages(connectionId): History cleared
    ChatBot --> WS: "Hello, how can I help you?"
else Chat
    ChatBot -[#blue]> Assistant: chat(connectionId, message)
    activate Assistant
    Assistant -> Redis: Retrieve chat history
    Assistant -> Mistral: Moderate message

    alt Message flagged
        Assistant -[#red]-> ChatBot: ModerationException
        ChatBot -[#red]-> WS: "I redirect you to a human..."
    else Message OK

        Assistant -[#blue]> Anthropic: Generate response with:\n- Chat history\n- User message
        activate Anthropic
        Anthropic -[#blue]-> Assistant: AI response
        deactivate Anthropic

        Assistant -> Redis: Store new messages
        Assistant -[#blue]-> ChatBot: response
    end
    deactivate Assistant

    ChatBot -[#blue]-> WS: AI response
end
deactivate ChatBot

WS -[#blue]-> User: Display response
deactivate WS

== Connection Close ==
User -> WS: Disconnect
activate WS
WS -> ChatBot: @OnClose()
activate ChatBot
ChatBot -> Redis: deleteMessages(connectionId)
deactivate ChatBot
deactivate WS

@enduml
